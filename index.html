<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</title>
<style>
  body { margin:0; font-family: sans-serif; background:#0f172a; color:#e2e8f0; }
  .wrap { max-width:780px; margin:0 auto; padding:12px; }
  .card { background:#111827; border-radius:18px; overflow:hidden; padding:10px; display:flex; flex-direction:column; height:90vh; }
  header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  #chat { display:flex; flex-direction:column; flex:1; }
  #messages { list-style:none; margin:0; padding:0; overflow:auto; display:flex; flex-direction:column; gap:10px; }
  #messages li { display:flex; align-items:flex-end; gap:8px; max-width:80%; }
  #messages li.mine { margin-inline-start:auto; flex-direction:row-reverse; }
  #messages li .bubble { cursor: pointer; }
  #messages img { width:36px; height:36px; border-radius:50%; object-fit:cover; border:1px solid #334155; }
  .bubble { background:#0b1220; border:1px solid #1f2937; padding:9px 12px; border-radius:14px; }
  .mine .bubble { background:#1d4ed8; border-color:#1d4ed8; color:white; }
  .meta { font-size:11px; opacity:.85; margin-bottom:4px; }
  form { display:flex; gap:8px; margin-top:auto; }
  input[type="text"] { flex:1; padding:10px; border-radius:12px; border:1px solid #374151; background:#0b1220; color:#e5e7eb; }
  button { padding:10px 12px; border-radius:12px; border:none; cursor:pointer; background:#3b82f6; color:white; }
  .overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:16px; }
  .modal { width:100%; max-width:420px; background:#111827; border-radius:16px; padding:16px; }
  .modal input { width:100%; padding:12px; border-radius:12px; border:1px solid #374151; background:#0b1220; color:#e5e7eb; }
  .topbar { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
  .topbar a { color:#3b82f6; text-decoration:none; font-size:18px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="topbar">
      <a href="ddd.html">â† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <h1>Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h1>
    </div>
    <section id="chat">
      <ul id="messages"></ul>
      <form id="messageForm">
        <input id="messageInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." maxlength="1000" autocomplete="off" />
        <button type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
      </form>
    </section>
  </div>
</div>

<div id="nameOverlay" class="overlay">
  <div class="modal">
    <h2>Ø£Ù‡Ù„Ø§Ù‹ ğŸ‘‹</h2>
    <p>Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ. Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</p>
    <input id="firstNameInput" type="text" placeholder="Ø§Ø³Ù…Ùƒ" maxlength="20" />
    <div style="margin-top:12px; display:flex; justify-content:flex-end;">
      <button id="saveFirstNameBtn">Ø§Ø¨Ø¯Ø£</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, serverTimestamp, query, orderByChild, limitToLast, remove } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD-ATbhT7UbESmsW_cSdVNqb7JhLobsTT4",
  authDomain: "chat-4f717.firebaseapp.com",
  databaseURL: "https://chat-4f717-default-rtdb.firebaseio.com",
  projectId: "chat-4f717",
  storageBucket: "chat-4f717.firebasestorage.app",
  messagingSenderId: "1049833929365",
  appId: "1:1049833929365:web:212eee0b364fb0ab11799c",
  measurementId: "G-022MRFC60Z"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const messagesEl = document.getElementById('messages');
const form = document.getElementById('messageForm');
const input = document.getElementById('messageInput');
const nameOverlay = document.getElementById('nameOverlay');
const firstNameInput = document.getElementById('firstNameInput');
const saveFirstBtn = document.getElementById('saveFirstNameBtn');

// clientId Ø«Ø§Ø¨Øª Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
if(!localStorage.getItem('chatClientId')) {
  localStorage.setItem('chatClientId', Math.random().toString(36).slice(2,12));
}

function avatarFromName(name) { return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&bold=true`; }

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù†
if(!localStorage.getItem('chatName')) { nameOverlay.style.display = 'flex'; }

saveFirstBtn.addEventListener('click', () => {
  const name = firstNameInput.value.trim();
  if(!name) return;
  localStorage.setItem('chatName', name);
  localStorage.setItem('chatAvatar', avatarFromName(name));
  nameOverlay.style.display = 'none';
});

let roomId = 'main';
const messagesRef = ref(db, `rooms/${roomId}/messages`);

function renderMessage(m, key) {
  const li = document.createElement('li');
  li.className = (m.clientId === localStorage.getItem('chatClientId')) ? 'mine':'theirs';
  const img = document.createElement('img');
  img.src = m.avatar || 'https://i.pravatar.cc/40';

  const bubble = document.createElement('div');
  bubble.className='bubble';
  bubble.dataset.key = key;

  const meta = document.createElement('div');
  meta.className='meta';
  meta.textContent = `${m.name} â€¢ ${new Date(m.ts).toLocaleString()}`;

  const text = document.createElement('div');
  text.className='text';
  text.textContent = m.text;

  bubble.append(meta,text);
  li.append(img,bubble);
  messagesEl.appendChild(li);
  messagesEl.lastElementChild.scrollIntoView({behavior:'smooth'});

  // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡
  if(m.clientId === localStorage.getItem('chatClientId')) {
    bubble.addEventListener('click', () => {
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) {
        remove(ref(db, `rooms/${roomId}/messages/${key}`));
      }
    });
  }
}

const messagesQuery = query(messagesRef, orderByChild('ts'), limitToLast(200));
onChildAdded(messagesQuery, snapshot => renderMessage(snapshot.val(), snapshot.key));

form.addEventListener('submit', e => {
  e.preventDefault();
  const text = input.value.trim();
  if(!text) return;
  push(messagesRef, {
    name: localStorage.getItem('chatName'),
    text: text,
    avatar: localStorage.getItem('chatAvatar'),
    clientId: localStorage.getItem('chatClientId'),
    ts: serverTimestamp()
  });
  input.value='';
});
</script>
</body>
</html>
