<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R.D.F - دردشة المدرسين</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* إخفاء اللون الأزرق عند الضغط على العناصر */
    * {
        -webkit-tap-highlight-color: transparent;
    }

    /* تأثيرات بديلة للحفاظ على تجربة المستخدم */
    a, button, .nav-item, .active-members-btn, .bubble, .reply-container, 
    .send-button, .back-button, .modal-button, .reply-preview-cancel {
        transition: all 0.2s ease;
    }

    a:active, button:active, .nav-item:active, .active-members-btn:active, 
    .bubble:active, .reply-container:active, .send-button:active, 
    .back-button:active, .modal-button:active, .reply-preview-cancel:active {
        transform: scale(0.98);
    }

    :root{
      --primary-color:#00AAFF; --secondary-color:#1e40af; --dark-bg:#0A0A12;
      --card-bg:#0A0A12; --border-color:#334155; --text-color:#e2e8f0;
      --my-msg-bg:#163E65; --other-msg-bg:#1E1E2A; --primary:#00aaff; --text:#e0e0e0;
      --glow:0 0 15px rgba(0,170,255,0.3);
      --reply-bg: rgba(255,255,255,0.1);
      --reply-border: #00aaff;
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma, Geneva, Verdana, sans-serif;}
    body{background:var(--dark-bg);color:var(--text-color);padding-top:80px;}
    .navbar{background:rgba(15,15,25,0.95);border-bottom:1px solid rgba(255,255,255,0.1);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;position:fixed;top:0;left:0;right:0;z-index:1000;backdrop-filter:blur(10px);box-shadow:0 5px 20px rgba(0,0,0,0.3);}
    .logo-container{display:flex;align-items:center;gap:0.8rem;}
    .logo-img{width:40px;height:40px;object-fit:cover;border-radius:50%;border:2px solid var(--primary);box-shadow:var(--glow);}
    .logo-text{font-size:1.2rem;font-weight:700;background:linear-gradient(to right,var(--primary),#00ddff);-webkit-background-clip:text;background-clip:text;color:transparent;}
    .nav-icons{display:flex;gap:1.2rem;}
    .nav-icon{color:var(--text);font-size:1.4rem;position:relative;transition:all .3s;display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:20%;background:rgba(255,255,255,0.05);text-decoration:none;}
    .nav-icon:hover{color:var(--primary);transform:translateY(-3px);background:rgba(0,170,255,0.1);}
    .notification-badge{position:absolute;top:-5px;right:-5px;background:#ff003c;color:white;font-size:.7rem;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;}

    .app-container{display:flex;flex-direction:column;height:calc(100vh - 80px);max-width:100%;margin:0 auto;}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:0px 16px;background:var(--card-bg);border-bottom:1px solid var(--border-color);height:55px;flex-shrink:0;}
    .topbar-left{display:flex;align-items:center;gap:15px;}
    .back-button{color:var(--primary-color);text-decoration:none;font-size:24px;display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;transition:background .2s;}
    .group-info{display:flex;align-items:center;gap:12px;}
    .group-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--primary-color);}
    .group-name{font-weight:600;font-size:18px;}
    .active-members-btn{display:flex;align-items:center;gap:8px;padding:8px 7px;background:rgba(0,170,255,0.1);color:var(--primary-color);text-decoration:none;border-radius:10px;font-size:12px;border:1px solid var(--primary-color);}
    .active-members-btn:hover{background:var(--primary-color);color:white;transform:translateY(-2px);box-shadow:var(--glow);}

    .chat-area{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--dark-bg);}
    .messages-container{flex:1;overflow-y:auto;padding:20px 16px;scroll-behavior:smooth;}
    .messages-container::-webkit-scrollbar{width:8px;}
    .messages-container::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:4px;}
    #messages{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;}

    /* تعديلات الرسائل - محاذاة بجانب الصورة */
    .message{
      display:flex;
      gap: 8px;
      max-width: 85%;
      animation:fadeIn .3s;
      align-items: flex-start;
    }

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px);}
      to{opacity:1;transform:translateY(0);}
    }

    .my-message{
      align-self:flex-end;
      flex-direction: row-reverse;
    }

    .other-message{
      align-self:flex-start;
    }

    .avatar{
      width:36px;
      height:36px;
      border-radius:50%;
      object-fit:cover;
      flex-shrink:0;
      border:1px solid var(--border-color);
      margin-top: 0; /* إزالة الهامش العلوي */
    }

    /* تعديل فقاعات الرسائل لتكون مستطيلة أكثر */
    .bubble {
      position: relative;
      padding: 8px 12px;
      border-radius: 8px; /* زوايا أقل استدارة */
      font-size: 14px;
      max-width: 100%;
      word-break: break-word;
      line-height: 1.4;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      min-width: 60px; /* عرض أدنى للفقاعة */
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .my-message .bubble {
      background: var(--my-msg-bg);
      color: white;
      border-top-left-radius: 8px;
      border-top-right-radius: 2px;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    .other-message .bubble {
      background: var(--other-msg-bg);
      color: var(--text-color);
      border-top-left-radius: 2px;
      border-top-right-radius: 8px;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }

    /* تأثير للضغط المزدوج */
    .bubble.double-tap-effect {
      animation: doubleTap 0.5s ease;
    }

    @keyframes doubleTap {
      0% { transform: scale(1); }
      50% { transform: scale(0.95); background-color: rgba(255, 0, 0, 0.2); }
      100% { transform: scale(1); }
    }

    /* تصغير وتعديل شكل الردود */
    .reply-container {
      background: rgba(255, 255, 255, 0.08);
      border-right: 3px solid var(--reply-border);
      border-radius: 4px; /* زوايا أقل استدارة */
      padding: 4px 8px; /* تصغير المسافات الداخلية */
      margin-bottom: 4px;
      max-width: 100%; /* استخدام العرض الكامل */
      cursor: pointer;
      font-size: 11px; /* تصغير الخط */
      transition: all 0.2s ease;
    }

    .reply-container:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    .reply-sender {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 1px;
      font-size: 10px;
    }

    .reply-text {
      color: var(--text-color);
      opacity: 0.9;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 10px;
    }

    /* معاينة الرد */
    .reply-preview {
      background: var(--reply-bg);
      border-right: 3px solid var(--reply-border);
      padding: 6px 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .reply-preview-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .reply-preview-sender {
      color: var(--primary-color);
      font-size: 12px;
      font-weight: 600;
    }

    .reply-preview-text {
      color: var(--text-color);
      opacity: 0.85;
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 250px;
    }

    .reply-preview-cancel {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 16px;
      cursor: pointer;
      padding: 5px;
      margin-right: 10px;
    }

    /* تحسين المسافات */
    .message-content {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
    }

    .message-info {
      font-size: 11px;
      opacity: 0.7;
      display: flex;
      gap: 8px;
      padding: 0 2px;
      margin-top: 1px;
    }

    .message-form {
      display: flex;
      gap: 12px;
      padding: 15px 16px;
      background: var(--dark-bg);
      position: relative;
      z-index: 10;
      flex-shrink: 0;
      flex-direction: column;
    }

    .message-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 50px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
      font-size: 15px;
      outline: none;
    }

    .send-button {
      padding: 12px 20px;
      border-radius: 30%;
      border: none;
      background: var(--primary-color);
      color: white;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 50px;
      height: 40px;
    }

    .send-button:hover {
      background: var(--secondary-color);
    }

    /* المودال والتنبيهات */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modal {
      background: #0F0919FF;
      padding: 20px;
      border-radius: 10px;
      width: 300px;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s ease;
      border: 0.4px solid #888;
    }

    .modal h2 {
      margin-bottom: 10px;
      font-size: 18px;
    }

    .modal p {
      font-size: 14px;
      margin-bottom: 15px;
    }

    .confirm-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .modal-button {
      flex: 1;
      padding: 8px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .delete-button {
      background-color: #f44336;
      color: #fff;
    }

    .delete-button:hover {
      background-color: #d32f2f;
    }

    .cancel-button {
      background-color: #ccc;
      color: #000;
    }

    .cancel-button:hover {
      background-color: #bbb;
    }

    .alert {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4caf50;
      color: #fff;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 14px;
      display: none;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: scale(0.9);}
      to {opacity: 1; transform: scale(1);}
    }

    @media (max-width:768px){
      .logo-text{font-size:1rem;}
      .group-name{font-size:14px;}
      .active-members-btn span{display:none;}
      .message{max-width:90%;}
      .message-form{padding:12px;}
      .bubble {
        max-width: 100%;
        padding: 8px 12px;
        font-size: 14px;
      }
      .message {
        gap: 6px;
      }
      .avatar {
        width: 32px;
        height: 32px;
      }
      .reply-text, .reply-preview-text {
        max-width: 200px;
      }
    }

    @media (max-width:480px){
      .message{max-width:95%;}
      .message-form{padding:10px;gap:8px;}
      .message-input{padding:10px 14px;font-size:14px;}
      .send-button{padding:10px;width:55px;height:38px;}
      .bubble {
        max-width: 100%;
        padding: 6px 10px;
        font-size: 13px;
      }
      .message {
        gap: 4px;
      }
      .avatar {
        width: 30px;
        height: 30px;
      }
      .reply-text, .reply-preview-text {
        max-width: 150px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo-container">
      <img src="https://i.postimg.cc/0QwwyJj3/image.png" width="100" alt="شعار R.D.F" class="lgo-img">
    </div>
    <div class="nav-icons">
     <a href="https://alriadh.github.io/ALRIADH1/Notificationsx-000/Abdx.NOTx.html" target="_blank" class="nav-icon"><i class="fa-regular fa-bell"></i></a>
      <a href="https://alriadh.github.io/ALRIADH1/X-AA-B/Abdx.ABOx.html" target="_blank" class="nav-icon"><i class="fas fa-info" style="color:#DDDDDD;font-size:19px;"></i></a>
    </div>
  </nav>

  <div class="app-container">
    <div class="topbar">
      <div class="topbar-left">
        <a href="https://alriadh.github.io/ALRIADH1/rdf-login/Abdx.HOMx.html" target="_blank" class="back-button"><img src="https://i.postimg.cc/ZRPL2rZg/image.png" width="24"></a>
        <div class="group-info">
          <img src="https://i.postimg.cc/Y0mv4vwt/propack-new.png" class="group-avatar">
          <div class="group-name">أخوة تحت عرش الرحمن</div>
        </div>
        <a href="https://alriadh.github.io/ALRIADH1/X-AA-B/Abdx.ACTx.html" target="_blank" class="active-members-btn"><i class="fas fa-users"> المتصلين</i><span></span></a>
      </div>
    </div>

    <div class="chat-area">
      <div class="messages-container" id="messagesContainer">
        <ul id="messages"></ul>
      </div>

      <form class="message-form" id="messageForm">
        <div class="reply-preview" id="replyPreview" style="display:none;">
          <div class="reply-preview-content">
            <div class="reply-preview-sender" id="replySender"></div>
            <div class="reply-preview-text" id="replyText"></div>
          </div>
          <button type="button" class="reply-preview-cancel" id="cancelReply">✕</button>
        </div>

        <div style="display:flex;gap:10px;align-items:flex-end;">
          <input type="text" class="message-input" id="messageInput" placeholder="اكتب رسالتك هنا..." maxlength="1000" autocomplete="off">
          <button type="submit" class="send-button"><i class="fas fa-paper-plane"></i></button>
        </div>
      </form>
    </div>
  </div>

  <div id="nameOverlay" class="overlay">
    <div class="modal">
      <h2>مرحباً 👋</h2>
      <p>أدخل اسمك للمشاركة في الدردشة. سيتم حفظ الاسم ولا يمكن تغييره لاحقاً.</p>
      <input type="text" class="modal-input" id="firstNameInput" placeholder="اسمك" maxlength="20">
      <div class="modal-buttons">
        <button class="modal-button confirm-button" id="saveFirstNameBtn">بدء المحادثة</button>
      </div>
    </div>
  </div>

  <div id="deleteConfirmModal" class="overlay confirm-modal">
    <div class="modal">
      <h2>حذف الرسالة</h2>
      <p>هل أنت متأكد من رغبتك في حذف هذه الرسالة؟</p>
      <div class="confirm-buttons">
        <button class="modal-button delete-button" id="confirmDeleteYes">نعم، احذف</button>
        <button class="modal-button cancel-button" id="confirmDeleteNo">إلغاء</button>
      </div>
    </div>
  </div>

  <div class="alert" id="alertMessage">تم حذف الرسالة</div>

  <script type="module">
    // imports موحّدة
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded, onChildRemoved,
      serverTimestamp, query, orderByChild, limitToLast,
      remove, get, update
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    /* إعدادات الدردشة */
    const chatConfig = {
      apiKey: "AIzaSyD-ATbhT7UbESmsW_cSdVNqb7JhLobsTT4",
      authDomain: "chat-4f717.firebaseapp.com",
      databaseURL: "https://chat-4f717-default-rtdb.firebaseio.com",
      projectId: "chat-4f717",
      storageBucket: "chat-4f717.firebasestorage.app",
      messagingSenderId: "1049833929365",
      appId: "1:1049833929365:web:212eee0b364fb0ab11799c",
      measurementId: "G-022MRFC60Z"
    };
    const chatApp = initializeApp(chatConfig, "chatApp");
    const db = getDatabase(chatApp);

    /* إعدادات active users */
    const activeConfig = {
      apiKey: "AIzaSyBkdgdvqCMDazd_lVDjk3AxBQv_NuoT2CY",
      authDomain: "activeusersproject.firebaseapp.com",
      databaseURL: "https://activeusersproject-default-rtdb.firebaseio.com",
      projectId: "activeusersproject",
      storageBucket: "activeusersproject.firebasestorage.app",
      messagingSenderId: "1758034379682",
      appId: "1:578197913531:web:74f4b5c2b7d0f429424e9e",
      measurementId: "G-TSP2J3ERRZ"
    };
    const activeApp = initializeApp(activeConfig, "activeApp");
    const activeDB = getDatabase(activeApp);

    // عناصر DOM
    const messagesEl = document.getElementById('messages');
    const messagesContainer = document.getElementById('messagesContainer');
    const form = document.getElementById('messageForm');
    const input = document.getElementById('messageInput');
    const nameOverlay = document.getElementById('nameOverlay');
    const firstNameInput = document.getElementById('firstNameInput');
    const saveFirstBtn = document.getElementById('saveFirstNameBtn');
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    const confirmDeleteYes = document.getElementById('confirmDeleteYes');
    const confirmDeleteNo = document.getElementById('confirmDeleteNo');
    const alertMessage = document.getElementById('alertMessage');

    // رد
    const replyPreview = document.getElementById('replyPreview');
    const replySender = document.getElementById('replySender');
    const replyText = document.getElementById('replyText');
    const cancelReplyBtn = document.getElementById('cancelReply');

    // متغيرات للضغط المزدوج
    let lastTap = 0;
    let currentMessageKey = null;

    if(!localStorage.getItem('chatClientId')) {
      localStorage.setItem('chatClientId', Math.random().toString(36).slice(2,12));
    }
    const clientId = localStorage.getItem('chatClientId');

    function avatarFromName(name){
      return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&bold=true&color=fff`;
    }

    if(!localStorage.getItem('chatName')){
      nameOverlay.style.display = 'flex';
    } else {
      // تأكد من وجود حساب المستخدم في DB
      const userRef = ref(db, `users/${clientId}`);
      get(userRef).then(snapshot=>{
        if(!snapshot.exists()){
          update(userRef, { name: localStorage.getItem('chatName'), avatar: localStorage.getItem('chatAvatar') || avatarFromName(localStorage.getItem('chatName')) });
        }
      }).catch(err => console.warn('user check err', err));
    }

    saveFirstBtn.addEventListener('click', ()=>{
      const name = firstNameInput.value.trim();
      if(!name) return;
      const avatar = avatarFromName(name);
      localStorage.setItem('chatName', name);
      localStorage.setItem('chatAvatar', avatar);
      nameOverlay.style.display = 'none';
      const userRef = ref(db, `users/${clientId}`);
      update(userRef, { name, avatar }).catch(err => console.error('save user err', err));
    });

    let roomId = 'main';
    const messagesRef = ref(db, `rooms/${roomId}/messages`);
    let currentMessageToDelete = null;
    let replyingToMessage = null;

    // تحويل أرقام عربية إلى إنجليزية
    function convertToEnglishNumbers(text) {
      if (!text) return text;
      const arabic = ['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'];
      const eng = ['0','1','2','3','4','5','6','7','8','9'];
      let out = text + '';
      for(let i=0;i<10;i++) out = out.replace(new RegExp(arabic[i],'g'), eng[i]);
      return out;
    }

    function formatGregorianDate(value){
      if(!value) return '';
      const d = new Date(value);
      if(isNaN(d.getTime())) return '';
      let s = d.toLocaleString('en-US',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:true});
      s = s.replace('AM','ص').replace('PM','م');
      return s;
    }

    // دالة للقفز إلى الرسالة الأصل عند الضغط على الرد
    function scrollToMessage(messageKey) {
      const targetBubble = document.querySelector(`.bubble[data-key="${messageKey}"]`);
      if (targetBubble) {
        targetBubble.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // إضافة تأثير تمييز للرسالة
        targetBubble.style.backgroundColor = 'rgba(0, 170, 255, 0.3)';
        setTimeout(() => {
          targetBubble.style.backgroundColor = '';
        }, 1500);
      }
    }

    // دالة للتعامل مع الضغط المزدوج
    function handleDoubleTap(messageKey, bubble) {
      const currentTime = new Date().getTime();
      const tapLength = currentTime - lastTap;

      if (lastTap && currentMessageKey === messageKey && tapLength < 500) {
        // الضغط المزدوج تم
        bubble.classList.add('double-tap-effect');
        currentMessageToDelete = messageKey;
        deleteConfirmModal.style.display = 'flex';
        lastTap = 0;
        currentMessageKey = null;
      } else {
        // الضغط الأول
        lastTap = currentTime;
        currentMessageKey = messageKey;

        // إعادة تعيين المؤقت بعد 500 مللي ثانية
        setTimeout(() => {
          lastTap = 0;
          currentMessageKey = null;
        }, 500);
      }
    }

    function setupSwipeToReply(){
      let startX=0, startY=0, currentBubble=null, isSwiping=false;
      document.addEventListener('touchstart', e=>{
        const b = e.target.closest('.bubble');
        if(b){ currentBubble = b; startX = e.touches[0].clientX; startY = e.touches[0].clientY; isSwiping = true; }
      });
      document.addEventListener('touchmove', e=>{
        if(!isSwiping || !currentBubble) return;
        const cx = e.touches[0].clientX, cy = e.touches[0].clientY;
        const diffX = startX - cx, diffY = startY - cy;
        if(Math.abs(diffY) > Math.abs(diffX)) return;
        if(diffX < -50){
          e.preventDefault();
          const messageKey = currentBubble.dataset.key;
          const messageText = currentBubble.querySelector('.message-text')?.textContent || '';
          const messageSender = currentBubble.closest('.message')?.querySelector('.message-info')?.textContent?.split('•')[0]?.trim() || '';
          showReplyPreview(messageSender, messageText, messageKey);
          isSwiping=false; currentBubble=null;
        }
      });
      document.addEventListener('touchend', ()=>{ isSwiping=false; currentBubble=null; });

      // For mouse (desktop)
      document.addEventListener('mousedown', e=>{
        const b = e.target.closest('.bubble');
        if(b){ currentBubble = b; startX = e.clientX; startY = e.clientY; isSwiping=true; }
      });
      document.addEventListener('mousemove', e=>{
        if(!isSwiping || !currentBubble) return;
        const cx = e.clientX, cy = e.clientY;
        const diffX = startX - cx, diffY = startY - cy;
        if(Math.abs(diffY) > Math.abs(diffX)) return;
        if(diffX < -100){
          const messageKey = currentBubble.dataset.key;
          const messageText = currentBubble.querySelector('.message-text')?.textContent || '';
          const messageSender = currentBubble.closest('.message')?.querySelector('.message-info')?.textContent?.split('•')[0]?.trim() || '';
          showReplyPreview(messageSender, messageText, messageKey);
          isSwiping=false; currentBubble=null;
        }
      });
      document.addEventListener('mouseup', ()=>{ isSwiping=false; currentBubble=null; });
    }

    function showReplyPreview(sender, text, messageKey){
      replySender.textContent = sender || 'رد';

      // اقتصاص النص الطويل
      const maxLength = 50;
      let displayText = text || '';
      if(displayText.length > maxLength) {
        displayText = displayText.substring(0, maxLength) + '...';
      }

      replyText.textContent = displayText;
      replyPreview.style.display = 'flex';
      replyingToMessage = messageKey;
      input.focus();
    }

    function cancelReply(){
      replyPreview.style.display = 'none';
      replyingToMessage = null;
    }

    cancelReplyBtn.addEventListener('click', cancelReply);

    function renderMessage(m, key){
      const li = document.createElement('li');
      li.className = 'message';
      const isMy = m.clientId === clientId;
      li.classList.add(isMy ? 'my-message' : 'other-message');

      const img = document.createElement('img');
      img.className = 'avatar';
      img.src = m.avatar || 'https://i.pravatar.cc/40';

      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';

      const meta = document.createElement('div');
      meta.className = 'message-info';
      meta.textContent = `${convertToEnglishNumbers(m.name || 'مجهول')} • ${formatGregorianDate(m.ts)}`;

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.dataset.key = key;
      bubble.dataset.clientId = m.clientId || '';

      // إضافة الرد إذا موجود
      if(m.replyTo && m.replyText){
        const replyContainer = document.createElement('div');
        replyContainer.className = 'reply-container';
        replyContainer.dataset.replyTo = m.replyTo; // حفظ مفتاح الرسالة الأصل

        // إضافة حدث النقر للرد
        replyContainer.addEventListener('click', () => {
          scrollToMessage(m.replyTo);
        });

        // جلب اسم المرسل الأصلي
        let originalSenderName = 'مجهول';
        if(m.replyTo){
          const replyMsgEl = document.querySelector(`.bubble[data-key="${m.replyTo}"]`);
          if(replyMsgEl){
            const msgElement = replyMsgEl.closest('.message');
            const infoText = msgElement.querySelector('.message-info')?.textContent?.split('•')[0]?.trim() || '';
            originalSenderName = infoText || 'مستخدم';
          }
        }

        const replySenderEl = document.createElement('div');
        replySenderEl.className = 'reply-sender';
        replySenderEl.textContent = originalSenderName;

        const replyTextEl = document.createElement('div');
        replyTextEl.className = 'reply-text';

        // اقتصاص نص الرد
        let replyDisplayText = m.replyText || '';
        const replyMaxLength = 60;
        if(replyDisplayText.length > replyMaxLength) {
          replyDisplayText = replyDisplayText.substring(0, replyMaxLength) + '...';
        }
        replyTextEl.textContent = replyDisplayText;

        replyContainer.appendChild(replySenderEl);
        replyContainer.appendChild(replyTextEl);
        bubble.appendChild(replyContainer);
      }

      const text = document.createElement('div');
      text.className = 'message-text';
      text.textContent = convertToEnglishNumbers(m.text || '');
      bubble.appendChild(text);

      messageContent.appendChild(meta);
      messageContent.appendChild(bubble);

      li.appendChild(img);
      li.appendChild(messageContent);

      messagesEl.appendChild(li);
      messagesContainer.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });

      // إضافة حدث الضغط المزدوج للرسائل الخاصة بالمستخدم
      if(isMy){
        bubble.addEventListener('click', (e)=>{
          e.stopPropagation();
          handleDoubleTap(key, bubble);
        });
      }
    }

    // عند إضافة رسالة من DB
    const messagesQuery = query(messagesRef, orderByChild('ts'), limitToLast(200));
    onChildAdded(messagesQuery, async snapshot=>{
      const msg = snapshot.val();
      const key = snapshot.key;
      if(!msg) return;
      try{
        const userSnap = await get(ref(db, `users/${msg.clientId}`));
        const userData = userSnap.exists() ? userSnap.val() : { name: msg.name || 'مجهول', avatar: msg.avatar };
        msg.name = userData.name || msg.name || 'مجهول';
        msg.avatar = userData.avatar || msg.avatar || '';
      }catch(err){
        console.warn('user fetch err', err);
      }
      renderMessage(msg, key);
    });

    // عند حذف رسالة من DB - ننظف من DOM بدون إعادة تحميل الصفحة
    onChildRemoved(messagesRef, snapshot=>{
      const key = snapshot.key;
      const bubble = document.querySelector(`.bubble[data-key="${key}"]`);
      if(bubble){
        const item = bubble.closest('.message');
        if(item) item.remove();
      }
    });

    // إرسال رسالة
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const text = input.value.trim();
      if(!text) return;
      if(!localStorage.getItem('chatName')){
        nameOverlay.style.display = 'flex';
        return;
      }
      const messageData = {
        text,
        clientId,
        name: localStorage.getItem('chatName'),
        avatar: localStorage.getItem('chatAvatar'),
        ts: serverTimestamp()
      };
      if(replyingToMessage){
        messageData.replyTo = replyingToMessage;
        const replyMsg = document.querySelector(`.bubble[data-key="${replyingToMessage}"]`);
        if(replyMsg){
          const rt = replyMsg.querySelector('.message-text')?.textContent || '';
          // اقتصاص نص الرد قبل حفظه
          const replyMaxLength = 100;
          messageData.replyText = rt.length > replyMaxLength ? 
            rt.substring(0, replyMaxLength) + '...' : rt;
        }
      }
      push(messagesRef, messageData).catch(err => console.error('push err', err));
      input.value = '';
      cancelReply();
    });

    // حذف رسالة (تأكيد)
    confirmDeleteYes.addEventListener('click', ()=>{
      if(currentMessageToDelete){
        remove(ref(db, `rooms/${roomId}/messages/${currentMessageToDelete}`))
          .then(()=> {
            alertMessage.style.display = 'block';
            setTimeout(()=>{ alertMessage.style.display = 'none'; }, 2500);
          })
          .catch(err => console.error('remove err', err));
      }
      deleteConfirmModal.style.display = 'none';
      currentMessageToDelete = null;
    });
    confirmDeleteNo.addEventListener('click', ()=>{
      deleteConfirmModal.style.display = 'none';
      currentMessageToDelete = null;
    });

    // تحديث نشاط المستخدم في activeUsersTest
   
   
    function updateActivity(){
      update(ref(activeDB, 'activeUsersTest/' + encodeURIComponent(activeUsername)), {
        name: activeName,
        avatar: activeAvatar,
        lastActive: Date.now()
      }).catch(err => console.warn('active update err', err));
    }
    updateActivity();
    setInterval(updateActivity, 10000);

    // تشغيل السحب
    setTimeout(()=>{ setupSwipeToReply(); }, 700);

    // DEBUG: لو في أخطاء افتح الكونسول وشوف
    console.info('Chat script loaded — clientId:', clientId);
  </script>
</body>
</html>