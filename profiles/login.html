<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل الدخول</title>
<style>
  body { font-family: Tahoma, Arial; background:#f0f4f8; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; }
  .card { background:#fff; padding:25px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,.1); width:320px; text-align:center; }
  input { width:100%; padding:12px; margin:8px 0; border:1px solid #ccc; border-radius:10px; }
  button { width:100%; padding:12px; margin-top:12px; border:none; border-radius:10px; background:#2563eb; color:#fff; font-size:16px; cursor:pointer; }
</style>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCXeOtXWIc1qyDIxh4EPu1nxmGswrNiqLo",
    authDomain: "password-a409.firebaseapp.com",
    databaseURL: "https://password-a409-default-rtdb.firebaseio.com",
    projectId: "password-a409",
    storageBucket: "password-a409.appspot.com",
    messagingSenderId: "883669716957",
    appId: "1:883669716957:web:e9c1222757dd10f3497034"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window.login = async function() {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;
    if(!username || !password) { alert("ادخل اسم المستخدم وكلمة المرور"); return; }

    const userRef = ref(db, "Users/" + username);
    const snap = await get(userRef);

    if(!snap.exists()) { alert("المستخدم غير موجود"); return; }

    const data = snap.val();
    const now = Date.now();
    const attempts = data.attempts || 0;
    const blockedUntil = data.blockedUntil || 0;
    const blockStage = data.blockStage || 0;

    if(now < blockedUntil) {
      alert("أنت محظور حتى: " + new Date(blockedUntil).toLocaleString());
      return;
    }

    if(data.password === password){
      await update(userRef, { attempts: 0, blockedUntil: 0, blockStage: 0 });
      window.location.href = "profiles/" + username + ".html";
      return;
    }

    // كلمة المرور خاطئة
    if(blockStage === 1){
      await update(userRef, { attempts: 0, blockedUntil: now + 24*60*60*1000, blockStage:0 });
      alert("محاولة خاطئة بعد الحظر. تم حظرك 24 ساعة.");
      return;
    }

    const newAttempts = attempts + 1;
    if(newAttempts >= 3){
      await update(userRef, { attempts: 0, blockedUntil: now + 30*60*1000, blockStage:1 });
      alert("تم استنفاذ المحاولات. تم حظرك 30 دقيقة.");
    } else {
      await update(userRef, { attempts: newAttempts });
      alert("كلمة المرور خاطئة. المحاولات المتبقية: " + (3 - newAttempts));
    }
  }
</script>
</head>
<body>
<div class="card">
  <h1>تسجيل الدخول</h1>
  <input id="username" type="text" placeholder="اسم المستخدم">
  <input id="password" type="password" placeholder="كلمة المرور">
  <button onclick="login()">دخول</button>
</div>
</body>
</html>
